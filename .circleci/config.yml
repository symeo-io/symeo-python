version: 2.1
orbs:
  python: circleci/python@2.0.3

jobs:
  build_and_test:
    executor: python/default
    working_directory: ~/symeo-python
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements.lock" }}
      - restore_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements-dev.lock" }}
      - run:
          name: Install requirements
          command: pip install -r requirements.txt
      - save_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements.lock" }}
          paths:
            - requirements.txt
      - run:
          name: Install dev requirements
          command: pip install -r requirements-dev.txt
      - save_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements-dev.lock" }}
          paths:
            - requirements-dev.txt
      - run:
          name: Run test with coverage
          command: coverage run -m pytest test
      - run:
          name: Display coverage
          command: coverage report
      - run:
          name: Build
          command: python -m build
      - save_cache:
          key: build-cache-{{ checksum "~/symeo-python/build.lock" }}
          paths:
            - /dist
  #      - run:
  #          name: Build Sphinx html documentation
  #          command: sphinx-build -b html docs/source/ docs/build/html

  validate-configuration:
    executor: python/default
    working_directory: ~/symeo-python
    steps:
    - checkout
    - restore_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements-dev.lock" }}
    - run:
        name: Install symeo-cli
        command: curl https://raw.githubusercontent.com/symeo-io/symeo-cli/main/scripts/install.sh | bash
    - run:
        name: Validate
        command: symeo-cli validate --api-key $SYMEO_API_KEY

  release:
    executor: python/default
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/build.lock" }}
      - restore_cache:
          key: dependency-cache-{{ checksum "~/symeo-python/requirements-dev.lock" }}
      - run:
          name: Install symeo-cli
          command: curl https://raw.githubusercontent.com/symeo-io/symeo-cli/main/scripts/install.sh | bash
      - run:
          name: Release version
          command: |
            version=$(echo $CIRCLE_TAG | cut -d '-' -f2)
            symeo-cli start --api-key $SYMEO_API_KEY -- twine upload dist/symeo-python-$version.tar.gz dist/symeo_python-$version-py3-none-any.whl -u $PYPI_USERNAME -p $PYPI_PASSWORD

workflows:
  build_test_release:
    jobs:
      - build_and_test:
          name: build_and_test
      - validate-configuration:
          name: validate-configuration-production
          requires:
            - build_and_test
          context:
            - symeo-python
          filters:
            branches:
              only:
                - main
      - release:
          name: release
          requires:
            - build_and_test
          context:
            - symeo-python
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^release-[0-9]+(\.[0-9]+)+$/